"use client";
import { deletePatientAction } from "@/actions/delete-patient-action";
import { getPatientAction } from "@/actions/get-patient-action";
import { Trash2 } from "lucide-react";
import { useAction } from "next-safe-action/hooks";
import { useParams, useRouter } from "next/navigation";
import { useEffect, useState } from "react";
import { toast } from "sonner";

import { ConfirmModal } from "@/components/shared/confirm-modal";
import { LoadingPatientProfile } from "@/components/shared/loading-state";
import PatientDocuments from "@/components/shared/patient-documents";
import PatientEvolution from "@/components/shared/patient-evolution";
import PatientInfo from "@/components/shared/patient-info";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import { Button } from "@/components/ui/button";

export default function PatientProfilePage() {
  const params = useParams();
  const router = useRouter();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const patientId = params.id as string;

  const { execute: fetchPatient, result, isPending } = useAction(getPatientAction);
  const { executeAsync: deletePatient, isPending: isDeleting } = useAction(deletePatientAction);

  useEffect(() => {
    fetchPatient({ patientId });
  }, [fetchPatient, patientId]);

  const patient = result.data?.patient;

  async function handleDelete() {
    const res = await deletePatient({ patientId });

    if (res?.serverError) {
      toast.error(res.serverError);
      setShowDeleteDialog(false);
      return;
    }

    toast.success("Paciente excluída com sucesso!");
    router.push("/patients");
  }

  if (isPending && !patient) {
    return <LoadingPatientProfile />;
  }

  if (!patient) {
    return null;
  }

  return (
    <>
      <div className="space-y-6">
        <Accordion type="single" collapsible className="w-full">
          <AccordionItem value="informacoes">
            <AccordionTrigger className="font-semibold text-base">
              <div className="flex w-full items-center justify-between pr-4">
                <span>Informações da Paciente</span>
              </div>
            </AccordionTrigger>
            <AccordionContent className="relative space-y-4 pt-4">
              <PatientInfo patient={patient} onChange={async () => { fetchPatient({ patientId }); }} />
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="cartao-prenatal">
            <AccordionTrigger className="font-semibold text-base">
              Cartão Pré-natal
            </AccordionTrigger>
            <AccordionContent>
              <p className="text-muted-foreground">Em breve...</p>
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="documentos">
            <AccordionTrigger className="font-semibold text-base">Documentos</AccordionTrigger>
            <AccordionContent>
              <PatientDocuments patientId={patient.id} />
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="evolucao">
            <AccordionTrigger className="font-semibold text-base">
              Evolução da Paciente
            </AccordionTrigger>
            <AccordionContent>
              <PatientEvolution patientId={patient.id} />
            </AccordionContent>
          </AccordionItem>
        </Accordion>

        <Button
          variant="destructive"
          className="w-full sm:w-auto"
          onClick={() => setShowDeleteDialog(true)}
        >
          <Trash2 className="mr-2 h-4 w-4" />
          Excluir Gestante
        </Button>
      </div>

      <ConfirmModal
        open={showDeleteDialog}
        onOpenChange={setShowDeleteDialog}
        title="Excluir paciente"
        description="Tem certeza que deseja excluir esta paciente? Esta ação não pode ser desfeita e todos os dados relacionados serão perdidos."
        confirmLabel="Excluir"
        variant="destructive"
        loading={isDeleting}
        onConfirm={handleDelete}
      />
    </>
  );
}
